# Open API

A collection of useful tools powered by Open API schema

## Installation

Install Python 3.6 (other versions may be compatible)

Clone this repository

```bash
git clone https://github.com/specify/open-api
cd open-api
```

Configure a virtual environment

```bash
python -m venv venv
```

Install the dependencies

```bash
./venv/bin/pip install -r requirements.txt
```

Install this package locally

```bash
pip install -e .
```

## Testing API

### (Optional) Define parameter constrains

If response object depends on the query parameters, you can
test for these relationships by adding your parameter names
and handler function to the `parameter_constraints` dictionary
in `src/validate/parameter_constraints.py`.

Each handler function would receive the following arguments:

* parameter_value (bool): the value of the parameter this handler
  works with
* path (str): name of the current endpoint (useful if the same
  parameter is shared between multiple endpoints)
* response (any): full response object

The handler function should return a boolean value saying validating
whether the response object is as expected

### Run the test

Run the test

```python
from open_api_tools.test.full_test import test as full_test
from open_api_tools.common.load_schema import load_schema

schema = load_schema('open_api.yaml')

# Error message schema is defined in open_api_tools.validate.index
def after_error_occurred(*error_message):
    print(error_message)

full_test(
    schema=schema,
    max_urls_per_endpoint=50,
    failed_request_limit=10,
    parameter_constraints={},
    after_error_occurred=after_error_occurred,
)
```

This script would automatically generate test URLs based on
your API schema.

All requests would be sent to the first server
specified in the `servers` part of the API schema.

### Supplying test values for parameters

By default, the test reads the `examples` object
[in the schema](https://swagger.io/specification/#example-object) to generate
request parameters. If `examples` wasn't provided, it would try to create some
test values based on the parameter type.

If you would like more customization, an optional `after_examples_generated`
hook can be provided to the `full_test.test` method.
`after_examples_generated` must be a function that accepts an endpoint name as
the first parameter and
[the parameter object](https://swagger.io/specification/#parameter-object)
as the second parameter (the parameter object would vary depending on how it is
defined in your schema). In turn, the function must return a list of valid
examples.

Example usage:

```python
from open_api_tools.test.full_test import test as full_test
from open_api_tools.common.load_schema import load_schema

schema = load_schema('open_api.yaml')

def after_error_occurred(*error_message):
    print(error_message)

def after_examples_generated(
    endpoint_name,
    parameter,
    autogenerated_examples
):
    return [
        parameter.name,
        endpoint_name,
        *parameter.examples,
        *autogenerated_examples
    ]

full_test(
    schema=schema,
    max_urls_per_endpoint=50,
    failed_request_limit=10,
    parameter_constraints={},
    after_error_occurred=after_error_occurred,
    after_examples_generated=after_examples_generated
)
```

The third parameter in `after_examples_generated` is the list of examples that
were generated by this framework. If you don't want to change the generated
examples, the function can return back this value. Example usage:

```python
def after_examples_generated(
    _endpoint_name,
    parameter,
    autogenerated_examples
):
    if parameter.schema.type == "string":
        return ["1","2"]
    else:
        return autogenerated_examples
```

Note that `after_examples_generated` would also get called with
`requestBody` as a parameter.name. This allows you to to provide a list of
request objects that would be used in testing. Each request object should be of
type `(str, str)`, where the first string is the MIME type and the second one is
the serialized payload that would be send with the request.

### Handling authentication and amending the request object

`full_test` also supports a `before_request_send` hook that allows you to modify
the request object before a request is sent. This is useful if you want to edit
the headers or add authentication cookies.

Example usage:

```python
# ... import statements

def before_request_send(endpoint_name, request_object):
    if endpoint_name == '/api/main/{id}/':
        if request_object.headers is None:
            request_object.headers = {}
        request_object.headers['Authorization']='Basic YWxhZGRpbjpvcGVuc2VzYW1l'
    return request_object

full_test(
    before_request_send=before_request_send
    # ...other parameters
)
```

The schema for the request object [is defined here
](https://docs.python-requests.org/en/master/api/).
